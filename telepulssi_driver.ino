
/*
  Telepulssi TP-KN10 slave LED screen driver
*/

#include <SPI.h>
#include <TimerOne.h>

static uint8_t koira14[] = {
  0x09, 0x00, 0x01, 0x00, 0x12, 0x04, 0x04, 0x04, 0x05, 0x00, 0x00, 0x00, 
  0x16, 0x0A, 0x06, 0x06, 0x03, 0x06, 0x0D, 0x07, 0x16, 0x0A, 0x04, 0x05, 
  0x03, 0x09, 0x05, 0x04, 0x1A, 0x04, 0x04, 0x1F, 0x05, 0x09, 0x05, 0x07, 
  0x1A, 0x00, 0x04, 0x04, 0x09, 0x06, 0x05, 0x07, 0x12, 0x0E, 0x04, 0x04, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, };
/*0x15, 0x00, 0x0A, 0x1F, 0x15, 0x04, 0x11, 0x00, 0x15, 0x1F, 0x0A, 0x00, 
  0x0A, 0x09, 0x08, 0x00, 0x15, 0x00, 0x0A, 0x1F, 0x15, 0x12, 0x04, 0x04, 
  0x15, 0x1F, 0x0A, 0x00, 0x0A, 0x04, 0x02, 0x04, 0x15, 0x00, 0x0A, 0x1F, 
  0x15, 0x09, 0x11, 0x00, 0x15, 0x1F, 0x0A, 0x00, 0x0A, 0x12, 0x08, 0x00, 
  0x15, 0x00, 0x0A, 0x1F, 0x15, 0x04, 0x04, 0x00, };
*/

void setup() {
	// Set output pins
	DDRC = 0xFF;
	DDRD = 0xFF;
	// initialize SPI:
	SPI.begin();
	Timer1.initialize(200);
	Timer1.attachInterrupt(driveDisplay);
}

uint8_t col_i = 0;
uint8_t row_i = 0;

void loop() {
}

void driveDisplay() {
	// Main screen turn off
	PORTC = 0xFF;
	PORTD = 0xFF; // Latch data on pin 5 at the same time

	if (col_i == 0) {
		SPI.transfer(1 << row_i);

		// Latch it
		digitalWrite(4, LOW);
		digitalWrite(4, HIGH);
	}
	
	// Main screen turn on.
	if (col_i < 2) {
		PORTD = ~((1 << 6) << col_i);
	} else {
		PORTC = ~(1 << (col_i-2));
	}
	
	// Prepare new data
	col_i++;
	
	// Advance to next row if needed
	if (col_i > 7) {
		col_i = 0;
		row_i++;
		if (row_i > 6) row_i = 0;
	}

	// Pull down latch
	digitalWrite(5, LOW);
	
	// Send new data and sleep a bit. FIXME use clock interrupt
	SPDR = koira14[8*row_i+col_i];
}
